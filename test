#!/usr/bin/env python3
"""
Script de test pour vÃ©rifier la configuration et les connexions (sans Vault)
"""

import os
from dotenv import load_dotenv
import requests
from requests.auth import HTTPBasicAuth
import sys

def test_confluent_connection():
    """Test de connexion Ã  Confluent Cloud"""
    print("ğŸ” Test de connexion Confluent Cloud...")
    
    api_key = os.getenv('CONFLUENT_API_KEY')
    api_secret = os.getenv('CONFLUENT_API_SECRET')
    
    if not api_key or not api_secret:
        print("âŒ Variables CONFLUENT_API_KEY et CONFLUENT_API_SECRET manquantes")
        return False
    
    try:
        response = requests.get(
            "https://api.confluent.cloud/iam/v2/service-accounts",
            auth=HTTPBasicAuth(api_key, api_secret),
            headers={'Accept': 'application/json'}
        )
        
        if response.status_code == 200:
            print("âœ… Connexion Confluent Cloud rÃ©ussie")
            data = response.json()
            print(f"   Nombre de service accounts existants: {len(data.get('data', []))}")
            return True
        else:
            print(f"âŒ Erreur Confluent Cloud: {response.status_code} - {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Erreur de connexion Confluent Cloud: {e}")
        return False

def test_storage_permissions():
    """Test des permissions de stockage local"""
    print("\nğŸ” Test des permissions de stockage...")
    
    storage_path = os.getenv('CREDENTIAL_STORAGE_PATH', './credentials')
    
    try:
        # CrÃ©er le rÃ©pertoire s'il n'existe pas
        if not os.path.exists(storage_path):
            os.makedirs(storage_path, mode=0o700)
            print(f"âœ… RÃ©pertoire crÃ©Ã©: {storage_path}")
        
        # Test d'Ã©criture
        test_file = os.path.join(storage_path, 'test.txt')
        with open(test_file, 'w') as f:
            f.write('test')
        
        # Test de lecture
        with open(test_file, 'r') as f:
            content = f.read()
        
        # Nettoyage
        os.remove(test_file)
        
        if content == 'test':
            print("âœ… Permissions de stockage OK")
            return True
        else:
            print("âŒ Erreur lors du test de lecture/Ã©criture")
            return False
            
    except Exception as e:
        print(f"âŒ Erreur de permissions de stockage: {e}")
        return False

def test_environment_variables():
    """VÃ©rification des variables d'environnement"""
    print("\nğŸ” VÃ©rification des variables d'environnement...")
    
    required_vars = [
        'CONFLUENT_API_KEY',
        'CONFLUENT_API_SECRET'
    ]
    
    optional_vars = [
        'CREDENTIAL_STORAGE_TYPE',
        'CREDENTIAL_STORAGE_PATH',
        'CONFLUENT_BASE_URL'
    ]
    
    missing_vars = []
    for var in required_vars:
        value = os.getenv(var)
        if not value:
            missing_vars.append(var)
        else:
            # Masquer les valeurs sensibles
            if 'SECRET' in var or 'TOKEN' in var:
                display_value = f"{value[:4]}***{value[-4:]}" if len(value) > 8 else "***"
            else:
                display_value = value
            print(f"   âœ… {var}: {display_value}")
    
    # Variables optionnelles
    for var in optional_vars:
        value = os.getenv(var)
        if value:
            print(f"   â„¹ï¸  {var}: {value}")
        else:
            print(f"   â– {var}: non dÃ©finie (valeur par dÃ©faut sera utilisÃ©e)")
    
    if missing_vars:
        print(f"\nâŒ Variables obligatoires manquantes: {', '.join(missing_vars)}")
        return False
    else:
        print("\nâœ… Toutes les variables obligatoires sont prÃ©sentes")
        return True

def test_credential_storage_config():
    """Test de la configuration du stockage des credentials"""
    print("\nğŸ” Test de la configuration du stockage...")
    
    storage_type = os.getenv('CREDENTIAL_STORAGE_TYPE', 'display')
    storage_path = os.getenv('CREDENTIAL_STORAGE_PATH', './credentials')
    
    print(f"   Mode de stockage: {storage_type}")
    
    if storage_type == 'display':
        print("   âœ… Mode display: les credentials seront affichÃ©es Ã  l'Ã©cran")
        return True
    elif storage_type == 'file':
        print(f"   Chemin de stockage: {storage_path}")
        return test_storage_permissions()
    elif storage_type == 'local':
        print("   âœ… Mode local: stockage en mÃ©moire (session uniquement)")
        return True
    else:
        print(f"   âŒ Mode de stockage non supportÃ©: {storage_type}")
        print("   Modes supportÃ©s: display, file, local")
        return False

def main():
    """Point d'entrÃ©e principal"""
    print("ğŸ§ª Script de test de configuration (sans Vault)\n")
    
    # Charger les variables d'environnement
    load_dotenv()
    
    # Tests
    tests = [
        test_environment_variables,
        test_confluent_connection,
        test_credential_storage_config
    ]
    
    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"âŒ Erreur lors du test: {e}")
            results.append(False)
    
    # RÃ©sumÃ©
    print("\n" + "="*50)
    print("ğŸ“Š RÃ©sumÃ© des tests:")
    
    if all(results):
        print("âœ… Tous les tests sont passÃ©s avec succÃ¨s!")
        print("ğŸš€ Vous pouvez maintenant utiliser le script create_tenant.py")
        print("\nğŸ’¡ Exemples d'utilisation:")
        print("   python create_tenant.py create --project my-project --cluster-id lkc-xxxxx")
        print("   python create_tenant.py create --project my-project --cluster-id lkc-xxxxx --storage-type file")
        sys.exit(0)
    else:
        print("âŒ Certains tests ont Ã©chouÃ©.")
        print("ğŸ”§ Veuillez corriger les erreurs avant d'utiliser le script principal.")
        sys.exit(1)

if __name__ == "__main__":
    main()
    print("\nğŸ” Test de connexion Vault...")
    
    vault_url = os.getenv('VAULT_URL')
    vault_token = os.getenv('VAULT_TOKEN')
    
    if not vault_url or not vault_token:
        print("âŒ Variables VAULT_URL et VAULT_TOKEN manquantes")
        return False
    
    try:
        client = hvac.Client(url=vault_url, token=vault_token)
        
        if client.is_authenticated():
            print("âœ… Connexion Vault rÃ©ussie")
            
            # Test d'Ã©criture/lecture
            test_path = "confluent/test/connection"
            test_data = {"test": "connection_ok"}
            
            client.secrets.kv.v2.create_or_update_secret(
                path=test_path,
                secret=test_data
            )
            print("âœ… Test d'Ã©criture Vault rÃ©ussi")
            
            result = client.secrets.kv.v2.read_secret_version(path=test_path)
            if result['data']['data']['test'] == 'connection_ok':
                print("âœ… Test de lecture Vault rÃ©ussi")
                
                # Nettoyage
                client.secrets.kv.v2.delete_metadata_and_all_versions(path=test_path)
                print("âœ… Nettoyage test Vault rÃ©ussi")
                return True
            else:
                print("âŒ Erreur lors de la lecture des donnÃ©es de test")
                return False
        else:
            print("âŒ Authentification Vault Ã©chouÃ©e")
            return False
            
    except Exception as e:
        print(f"âŒ Erreur de connexion Vault: {e}")
        return False

def test_environment_variables():
    """VÃ©rification des variables d'environnement"""
    print("\nğŸ” VÃ©rification des variables d'environnement...")
    
    required_vars = [
        'CONFLUENT_API_KEY',
        'CONFLUENT_API_SECRET',
        'VAULT_URL',
        'VAULT_TOKEN'
    ]
    
    missing_vars = []
    for var in required_vars:
        value = os.getenv(var)
        if not value:
            missing_vars.append(var)
        else:
            # Masquer les valeurs sensibles
            if 'SECRET' in var or 'TOKEN' in var:
                display_value = f"{value[:4]}***{value[-4:]}" if len(value) > 8 else "***"
            else:
                display_value = value
            print(f"   âœ… {var}: {display_value}")
    
    if missing_vars:
        print(f"\nâŒ Variables manquantes: {', '.join(missing_vars)}")
        return False
    else:
        print("\nâœ… Toutes les variables d'environnement sont prÃ©sentes")
        return True

def main():
    """Point d'entrÃ©e principal"""
    print("ğŸ§ª Script de test de configuration\n")
    
    # Charger les variables d'environnement
    load_dotenv()
    
    # Tests
    tests = [
        test_environment_variables,
        test_confluent_connection,
        test_vault_connection
    ]
    
    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"âŒ Erreur lors du test: {e}")
            results.append(False)
    
    # RÃ©sumÃ©
    print("\n" + "="*50)
    print("ğŸ“Š RÃ©sumÃ© des tests:")
    
    if all(results):
        print("âœ… Tous les tests sont passÃ©s avec succÃ¨s!")
        print("ğŸš€ Vous pouvez maintenant utiliser le script create_tenant.py")
        sys.exit(0)
    else:
        print("âŒ Certains tests ont Ã©chouÃ©.")
        print("ğŸ”§ Veuillez corriger les erreurs avant d'utiliser le script principal.")
        sys.exit(1)

if __name__ == "__main__":
    main()
