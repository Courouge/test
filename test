#!/usr/bin/env python3
"""
Script de test pour vérifier la configuration et les connexions (sans Vault)
"""

import os
from dotenv import load_dotenv
import requests
from requests.auth import HTTPBasicAuth
import sys

def test_confluent_connection():
    """Test de connexion à Confluent Cloud"""
    print("🔍 Test de connexion Confluent Cloud...")
    
    api_key = os.getenv('CONFLUENT_API_KEY')
    api_secret = os.getenv('CONFLUENT_API_SECRET')
    
    if not api_key or not api_secret:
        print("❌ Variables CONFLUENT_API_KEY et CONFLUENT_API_SECRET manquantes")
        return False
    
    try:
        response = requests.get(
            "https://api.confluent.cloud/iam/v2/service-accounts",
            auth=HTTPBasicAuth(api_key, api_secret),
            headers={'Accept': 'application/json'}
        )
        
        if response.status_code == 200:
            print("✅ Connexion Confluent Cloud réussie")
            data = response.json()
            print(f"   Nombre de service accounts existants: {len(data.get('data', []))}")
            return True
        else:
            print(f"❌ Erreur Confluent Cloud: {response.status_code} - {response.text}")
            return False
            
    except Exception as e:
        print(f"❌ Erreur de connexion Confluent Cloud: {e}")
        return False

def test_storage_permissions():
    """Test des permissions de stockage local"""
    print("\n🔍 Test des permissions de stockage...")
    
    storage_path = os.getenv('CREDENTIAL_STORAGE_PATH', './credentials')
    
    try:
        # Créer le répertoire s'il n'existe pas
        if not os.path.exists(storage_path):
            os.makedirs(storage_path, mode=0o700)
            print(f"✅ Répertoire créé: {storage_path}")
        
        # Test d'écriture
        test_file = os.path.join(storage_path, 'test.txt')
        with open(test_file, 'w') as f:
            f.write('test')
        
        # Test de lecture
        with open(test_file, 'r') as f:
            content = f.read()
        
        # Nettoyage
        os.remove(test_file)
        
        if content == 'test':
            print("✅ Permissions de stockage OK")
            return True
        else:
            print("❌ Erreur lors du test de lecture/écriture")
            return False
            
    except Exception as e:
        print(f"❌ Erreur de permissions de stockage: {e}")
        return False

def test_environment_variables():
    """Vérification des variables d'environnement"""
    print("\n🔍 Vérification des variables d'environnement...")
    
    required_vars = [
        'CONFLUENT_API_KEY',
        'CONFLUENT_API_SECRET'
    ]
    
    optional_vars = [
        'CREDENTIAL_STORAGE_TYPE',
        'CREDENTIAL_STORAGE_PATH',
        'CONFLUENT_BASE_URL'
    ]
    
    missing_vars = []
    for var in required_vars:
        value = os.getenv(var)
        if not value:
            missing_vars.append(var)
        else:
            # Masquer les valeurs sensibles
            if 'SECRET' in var or 'TOKEN' in var:
                display_value = f"{value[:4]}***{value[-4:]}" if len(value) > 8 else "***"
            else:
                display_value = value
            print(f"   ✅ {var}: {display_value}")
    
    # Variables optionnelles
    for var in optional_vars:
        value = os.getenv(var)
        if value:
            print(f"   ℹ️  {var}: {value}")
        else:
            print(f"   ➖ {var}: non définie (valeur par défaut sera utilisée)")
    
    if missing_vars:
        print(f"\n❌ Variables obligatoires manquantes: {', '.join(missing_vars)}")
        return False
    else:
        print("\n✅ Toutes les variables obligatoires sont présentes")
        return True

def test_credential_storage_config():
    """Test de la configuration du stockage des credentials"""
    print("\n🔍 Test de la configuration du stockage...")
    
    storage_type = os.getenv('CREDENTIAL_STORAGE_TYPE', 'display')
    storage_path = os.getenv('CREDENTIAL_STORAGE_PATH', './credentials')
    
    print(f"   Mode de stockage: {storage_type}")
    
    if storage_type == 'display':
        print("   ✅ Mode display: les credentials seront affichées à l'écran")
        return True
    elif storage_type == 'file':
        print(f"   Chemin de stockage: {storage_path}")
        return test_storage_permissions()
    elif storage_type == 'local':
        print("   ✅ Mode local: stockage en mémoire (session uniquement)")
        return True
    else:
        print(f"   ❌ Mode de stockage non supporté: {storage_type}")
        print("   Modes supportés: display, file, local")
        return False

def main():
    """Point d'entrée principal"""
    print("🧪 Script de test de configuration (sans Vault)\n")
    
    # Charger les variables d'environnement
    load_dotenv()
    
    # Tests
    tests = [
        test_environment_variables,
        test_confluent_connection,
        test_credential_storage_config
    ]
    
    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"❌ Erreur lors du test: {e}")
            results.append(False)
    
    # Résumé
    print("\n" + "="*50)
    print("📊 Résumé des tests:")
    
    if all(results):
        print("✅ Tous les tests sont passés avec succès!")
        print("🚀 Vous pouvez maintenant utiliser le script create_tenant.py")
        print("\n💡 Exemples d'utilisation:")
        print("   python create_tenant.py create --project my-project --cluster-id lkc-xxxxx")
        print("   python create_tenant.py create --project my-project --cluster-id lkc-xxxxx --storage-type file")
        sys.exit(0)
    else:
        print("❌ Certains tests ont échoué.")
        print("🔧 Veuillez corriger les erreurs avant d'utiliser le script principal.")
        sys.exit(1)

if __name__ == "__main__":
    main()
    print("\n🔍 Test de connexion Vault...")
    
    vault_url = os.getenv('VAULT_URL')
    vault_token = os.getenv('VAULT_TOKEN')
    
    if not vault_url or not vault_token:
        print("❌ Variables VAULT_URL et VAULT_TOKEN manquantes")
        return False
    
    try:
        client = hvac.Client(url=vault_url, token=vault_token)
        
        if client.is_authenticated():
            print("✅ Connexion Vault réussie")
            
            # Test d'écriture/lecture
            test_path = "confluent/test/connection"
            test_data = {"test": "connection_ok"}
            
            client.secrets.kv.v2.create_or_update_secret(
                path=test_path,
                secret=test_data
            )
            print("✅ Test d'écriture Vault réussi")
            
            result = client.secrets.kv.v2.read_secret_version(path=test_path)
            if result['data']['data']['test'] == 'connection_ok':
                print("✅ Test de lecture Vault réussi")
                
                # Nettoyage
                client.secrets.kv.v2.delete_metadata_and_all_versions(path=test_path)
                print("✅ Nettoyage test Vault réussi")
                return True
            else:
                print("❌ Erreur lors de la lecture des données de test")
                return False
        else:
            print("❌ Authentification Vault échouée")
            return False
            
    except Exception as e:
        print(f"❌ Erreur de connexion Vault: {e}")
        return False

def test_environment_variables():
    """Vérification des variables d'environnement"""
    print("\n🔍 Vérification des variables d'environnement...")
    
    required_vars = [
        'CONFLUENT_API_KEY',
        'CONFLUENT_API_SECRET',
        'VAULT_URL',
        'VAULT_TOKEN'
    ]
    
    missing_vars = []
    for var in required_vars:
        value = os.getenv(var)
        if not value:
            missing_vars.append(var)
        else:
            # Masquer les valeurs sensibles
            if 'SECRET' in var or 'TOKEN' in var:
                display_value = f"{value[:4]}***{value[-4:]}" if len(value) > 8 else "***"
            else:
                display_value = value
            print(f"   ✅ {var}: {display_value}")
    
    if missing_vars:
        print(f"\n❌ Variables manquantes: {', '.join(missing_vars)}")
        return False
    else:
        print("\n✅ Toutes les variables d'environnement sont présentes")
        return True

def main():
    """Point d'entrée principal"""
    print("🧪 Script de test de configuration\n")
    
    # Charger les variables d'environnement
    load_dotenv()
    
    # Tests
    tests = [
        test_environment_variables,
        test_confluent_connection,
        test_vault_connection
    ]
    
    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"❌ Erreur lors du test: {e}")
            results.append(False)
    
    # Résumé
    print("\n" + "="*50)
    print("📊 Résumé des tests:")
    
    if all(results):
        print("✅ Tous les tests sont passés avec succès!")
        print("🚀 Vous pouvez maintenant utiliser le script create_tenant.py")
        sys.exit(0)
    else:
        print("❌ Certains tests ont échoué.")
        print("🔧 Veuillez corriger les erreurs avant d'utiliser le script principal.")
        sys.exit(1)

if __name__ == "__main__":
    main()
